<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cable Services Management</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <!-- Login Page -->
    <div id="loginPage" class="page active">
        <div class="login-container">
            <div class="login-box">
                <h1>Cable Services Management</h1>
                <form id="loginForm">
                    <div class="form-group">
                        <label for="username">Username</label>
                        <input type="text" id="username" required>
                    </div>
                    <div class="form-group">
                        <label for="password">Password</label>
                        <input type="password" id="password" required>
                    </div>
                    <div class="form-group">
                        <label for="role">Role</label>
                        <select id="role" required>
                            <option value="">Select Role</option>
                            <option value="admin">Admin</option>
                            <option value="agent">Collection Agent</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary">Login</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Main Application -->
    <div id="appPage" class="page">
        <!-- Sidebar Navigation -->
        <nav class="sidebar">
            <div class="sidebar-header">
                <h2>Cable Services</h2>
                <p id="userInfo"></p>
            </div>
            <ul class="nav-menu">
                <li><a href="#dashboard" class="nav-link active">Dashboard</a></li>
                <li id="customersNav"><a href="#customers" class="nav-link">Customers</a></li>
                <li id="packagesNav" style="display: none;"><a href="#packages" class="nav-link">Packages</a></li>
                <li id="agentsNav" style="display: none;"><a href="#agents" class="nav-link">Collection Agents</a></li>
                <li id="reportsNav"><a href="#reports" class="nav-link">Reports</a></li>
                <li id="remindersNav" style="display: none;"><a href="#reminders" class="nav-link">Reminders</a></li>
                <li id="settingsNav"><a href="#settings" class="nav-link">Settings</a></li>
                <li><a href="#" id="logoutBtn" class="nav-link">Logout</a></li>
            </ul>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Dashboard -->
            <section id="dashboard" class="content-section active">
                <h1>Dashboard</h1>
                <div class="stats-grid" id="dashboardStats">
                    <div class="stat-card">
                        <h3 id="stat1Title">Total Customers</h3>
                        <p id="totalCustomers">0</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="stat2Title">Unpaid Customers</h3>
                        <p id="unpaidCustomers">0</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="stat3Title">Total Collections (This Month)</h3>
                        <p id="monthlyCollection">₹0</p>
                    </div>
                    <div class="stat-card" id="stat4Card">
                        <h3 id="stat4Title">Today's Collection</h3>
                        <p id="dailyCollection">₹0</p>
                    </div>
                    <div class="stat-card" id="stat5Card">
                        <h3 id="stat5Title">Today Paid Customers</h3>
                        <p id="todayPaidCustomers">0</p>
                    </div>
                    <div class="stat-card" id="stat6Card">
                        <h3 id="stat6Title">Total Month Collection</h3>
                        <p id="totalMonthCollection">₹0</p>
                    </div>
                </div>
                
                <!-- Admin Monthly Paid Customers Chart -->
                <div id="adminMonthlyChartSection" style="display: none; margin-top: 30px;">
                    <div class="card" style="padding: 20px;">
                        <h2>Monthly Paid Customers Chart</h2>
                        <p style="color: var(--text-secondary); margin-bottom: 15px;">
                            Total paid customers count by subscription month for the current year
                        </p>
                        <div style="position: relative; height: 400px; margin-top: 20px;">
                            <canvas id="adminMonthlyChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <!-- Admin Payment Collection Section -->
                <div id="adminPaymentCollectionSection" style="display: none; margin-top: 30px;">
                    <div class="card" style="padding: 20px;">
                        <h2>Collect Payment - Search Customer</h2>
                        <p style="color: var(--text-secondary); margin-bottom: 15px;">
                            Search customer by Phone Number, ID Number, or Box Number to collect payment for respective month subscription
                        </p>
                        
                        <!-- Search Section -->
                        <div style="margin-bottom: 20px;">
                            <div class="form-group" style="display: flex; gap: 10px; align-items: flex-end;">
                                <div style="flex: 1;">
                                    <label for="adminCustomerSearchInput">Search Customer:</label>
                                    <input 
                                        type="text" 
                                        id="adminCustomerSearchInput" 
                                        placeholder="Enter Phone Number, ID Number, or Box Number"
                                        class="form-control"
                                        style="width: 100%; padding: 10px; margin-top: 5px;"
                                    />
                                    <p style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 5px;">
                                        Search all customers by Phone Number, ID Number, or Box Number.
                                    </p>
                                </div>
                                <button id="adminSearchCustomerBtn" class="btn btn-primary" style="height: fit-content;">Search</button>
                            </div>
                        </div>
                        
                        <!-- Customer Info Display -->
                        <div id="adminCustomerInfo" style="display: none; padding: 15px; background-color: var(--bg-color); border-radius: 6px; margin-top: 15px;"></div>
                    </div>
                </div>
                
                <!-- Monthly Collection Chart (for agents only) -->
                <div id="agentMonthlyChartSection" style="display: none; margin-top: 30px;">
                    <div class="card" style="padding: 20px;">
                        <h2>Monthly Collection Chart</h2>
                        <p style="color: var(--text-secondary); margin-bottom: 15px;">
                            Paid customers count by subscription month for the current year
                        </p>
                        <div style="position: relative; height: 400px; margin-top: 20px;">
                            <canvas id="agentMonthlyChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <!-- Collection Reports Section (for agents only) -->
                <div id="agentReportsSection" style="display: none; margin-top: 30px;">
                    <div class="card" style="padding: 20px;">
                        <h2>Collection Reports</h2>
                        <div style="margin-bottom: 20px;">
                            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                <button id="agentDailyReportBtn" class="btn btn-primary">Today's Collections</button>
                                <button id="agentMonthlyReportBtn" class="btn btn-primary">Monthly Collections</button>
                                <button id="agentPaymentHistoryBtn" class="btn btn-primary">Payment History</button>
                                <button id="agentCustomerReportBtn" class="btn btn-primary">Customer Status</button>
                            </div>
                        </div>
                        <div id="agentReportContent" style="margin-top: 20px;"></div>
                    </div>
                </div>
                
                <!-- Barcode Scanner Section (for agents only) -->
                <div id="barcodeScannerSection" style="display: none; margin-top: 30px;">
                    <div class="card" style="padding: 20px;">
                        <h2>Collect Payment - Scan or Search Customer</h2>
                        <p style="color: var(--text-secondary); margin-bottom: 15px;">
                            Scan barcode or search by Phone Number / ID Number / Box Number to view customer details and collect payment for respective month subscription
                        </p>
                        
                        <!-- Manual Input Section -->
                        <div style="margin-bottom: 20px;">
                            <div class="form-group" style="display: flex; gap: 10px; align-items: flex-end;">
                                <div style="flex: 1;">
                                    <label for="manualCustomerIdInput">Search Customer:</label>
                                    <input 
                                        type="text" 
                                        id="manualCustomerIdInput" 
                                        placeholder="Enter Phone Number, ID Number, or Box Number"
                                        class="form-control"
                                        style="width: 100%; padding: 10px; margin-top: 5px;"
                                    />
                                    <p style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 5px;">
                                        Search all customers by Phone Number, ID Number, or Box Number. All agents can collect payments from any customer.
                                    </p>
                                </div>
                                <button id="searchCustomerBtn" class="btn btn-primary" style="height: fit-content;">Search</button>
                            </div>
                        </div>
                        
                        <div style="text-align: center; margin: 20px 0; color: var(--text-secondary);">
                            <strong>OR</strong>
                        </div>
                        
                        <!-- Barcode Scanner Section -->
                        <div style="margin-bottom: 15px;">
                            <button id="startScannerBtn" class="btn btn-primary">Start Barcode Scanner</button>
                            <button id="stopScannerBtn" class="btn btn-secondary" style="display: none;">Stop Scanner</button>
                        </div>
                        <div id="scannerContainer" style="display: none; margin-bottom: 15px;">
                            <!-- Scanner will be inserted here -->
                        </div>
                        <div id="scannedCustomerInfo" style="display: none; padding: 15px; background-color: var(--bg-color); border-radius: 6px; margin-top: 15px;"></div>
                    </div>
                </div>
                
                <div class="recent-section" id="recentPaymentsSection">
                    <h2>Recent Payments</h2>
                    <div id="recentPayments"></div>
                </div>
            </section>

            <!-- Customers Section -->
            <section id="customers" class="content-section">
                <div class="section-header">
                    <h1>Customers</h1>
                    <div style="display: flex; gap: 10px;">
                        <button id="exportExcelBtn" class="btn btn-secondary" style="display: none;">Export to Excel</button>
                        <button id="importExcelBtn" class="btn btn-success" style="display: none;">Import from Excel</button>
                        <button id="addCustomerBtn" class="btn btn-primary" style="display: none;">Add Customer</button>
                    </div>
                </div>
                <div class="filter-bar">
                    <input type="text" id="customerSearch" placeholder="Search customers...">
                    <select id="customerFilterAgent">
                        <option value="">All Agents</option>
                    </select>
                    <select id="customerFilterStatus">
                        <option value="">All Status</option>
                        <option value="paid">Paid</option>
                        <option value="unpaid">Unpaid</option>
                    </select>
                </div>
                <div id="customersList"></div>
            </section>

            <!-- Packages Section -->
            <section id="packages" class="content-section">
                <div class="section-header">
                    <h1>Packages</h1>
                    <button id="addPackageBtn" class="btn btn-primary">Add Package</button>
                </div>
                <div id="packagesList"></div>
            </section>

            <!-- Agents Section -->
            <section id="agents" class="content-section">
                <div class="section-header">
                    <h1>Collection Agents</h1>
                    <button id="addAgentBtn" class="btn btn-primary">Add Agent</button>
                </div>
                <div id="agentsList"></div>
            </section>

            <!-- Reports Section -->
            <section id="reports" class="content-section">
                <h1>Reports</h1>
                <div class="reports-menu">
                    <button class="report-btn" data-report="monthly">Monthly Collection Report</button>
                    <button class="report-btn" data-report="daily">Daily Collection Agent Report</button>
                    <button class="report-btn" data-report="total">Total Customers Report</button>
                    <button class="report-btn" data-report="unpaid">Unpaid Customers Report</button>
                </div>
                <div id="reportContent"></div>
            </section>

            <section id="reminders" class="content-section">
                <h1>Payment Reminders</h1>
                <div id="remindersContent"></div>
            </section>

            <!-- Settings Section -->
            <section id="settings" class="content-section">
                <h1>Settings</h1>
                <div class="settings-form">
                    <div class="form-group">
                        <label for="upiId">UPI ID</label>
                        <input type="text" id="upiId" placeholder="yourname@upi">
                        <button class="btn btn-primary" id="saveUpiBtn">Save UPI ID</button>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Modals -->
    <!-- Edit Payment Modal (Admin Only) -->
    <div id="editPaymentModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <span class="close" onclick="closeModal('editPaymentModal')">&times;</span>
            <h2>Edit Collection Payment</h2>
            <form id="editPaymentForm">
                <input type="hidden" id="editPaymentId">
                <div class="form-group">
                    <label for="editPaymentCustomer">Customer:</label>
                    <input type="text" id="editPaymentCustomer" readonly style="background-color: #f5f5f5;">
                </div>
                <div class="form-group">
                    <label for="editPaymentSubscriptionMonth">Subscription Month:</label>
                    <select id="editPaymentSubscriptionMonth" class="form-control" required>
                        <option value="1">January</option>
                        <option value="2">February</option>
                        <option value="3">March</option>
                        <option value="4">April</option>
                        <option value="5">May</option>
                        <option value="6">June</option>
                        <option value="7">July</option>
                        <option value="8">August</option>
                        <option value="9">September</option>
                        <option value="10">October</option>
                        <option value="11">November</option>
                        <option value="12">December</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="editPaymentSubscriptionYear">Subscription Year:</label>
                    <input type="number" id="editPaymentSubscriptionYear" min="2020" max="2100" required>
                </div>
                <div class="form-group">
                    <label for="editPaymentCollectionDate">Collection Date:</label>
                    <input type="date" id="editPaymentCollectionDate" required>
                </div>
                <div class="form-group">
                    <label for="editPaymentAmount">Amount (₹):</label>
                    <input type="number" id="editPaymentAmount" step="0.01" min="0" required>
                </div>
                <div class="form-group">
                    <label for="editPaymentAgent">Collected By Agent:</label>
                    <select id="editPaymentAgent" class="form-control" required>
                        <option value="">Select Agent</option>
                    </select>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-primary" onclick="reportManager.savePaymentEdit()">Save Changes</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('editPaymentModal')">Cancel</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Customer Modal -->
    <div id="customerModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2 id="customerModalTitle">Add Customer</h2>
            <form id="customerForm">
                <input type="hidden" id="customerId">
                <div class="form-group">
                    <label for="customerOffice">Office <span style="color: var(--text-secondary); font-size: 0.85rem;">(can be added later)</span></label>
                    <input type="text" id="customerOffice">
                </div>
                <div class="form-group">
                    <label for="customerSerialNo">Serial No <span style="color: var(--text-secondary); font-size: 0.85rem;">(can be added later)</span></label>
                    <input type="text" id="customerSerialNo">
                </div>
                <div class="form-group">
                    <label for="customerName">Customer Name *</label>
                    <input type="text" id="customerName" required>
                </div>
                <div class="form-group">
                    <label for="customerPhone">Phone Number <span style="color: var(--text-secondary); font-size: 0.85rem;">(can be added later)</span></label>
                    <input type="tel" id="customerPhone">
                </div>
                <div class="form-group">
                    <label for="customerArea">Area <span style="color: var(--text-secondary); font-size: 0.85rem;">(can be added later)</span></label>
                    <input type="text" id="customerArea">
                </div>
                <div class="form-group">
                    <label for="customerPackage">Package <span style="color: var(--text-secondary); font-size: 0.85rem;">(can be added later)</span></label>
                    <select id="customerPackage"></select>
                </div>
                <div class="form-group">
                    <label for="customerIdNumber">ID <span style="color: var(--text-secondary); font-size: 0.85rem;">(can be added later)</span></label>
                    <input type="text" id="customerIdNumber">
                </div>
                <div class="form-group">
                    <label for="customerBoxNumber">Box Number *</label>
                    <input type="text" id="customerBoxNumber" required>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">Save</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('customerModal')">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Package Modal -->
    <div id="packageModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2 id="packageModalTitle">Add Package</h2>
            <form id="packageForm">
                <input type="hidden" id="packageId">
                <div class="form-group">
                    <label for="packageName">Package Name *</label>
                    <input type="text" id="packageName" required>
                </div>
                <div class="form-group">
                    <label for="packagePrice">Price (₹) *</label>
                    <input type="number" id="packagePrice" step="0.01" required>
                </div>
                <div class="form-group">
                    <label for="packageDescription">Description</label>
                    <textarea id="packageDescription"></textarea>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">Save</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('packageModal')">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Agent Modal -->
    <div id="agentModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2 id="agentModalTitle">Add Collection Agent</h2>
            <form id="agentForm">
                <input type="hidden" id="agentId">
                <div class="form-group">
                    <label for="agentName">Agent Name *</label>
                    <input type="text" id="agentName" required>
                </div>
                <div class="form-group">
                    <label for="agentAgentId">Agent ID *</label>
                    <input type="text" id="agentAgentId" required>
                </div>
                <div class="form-group">
                    <label for="agentPhone">Phone Number *</label>
                    <input type="tel" id="agentPhone" required>
                </div>
                <div class="form-group">
                    <label for="agentEmail">Email</label>
                    <input type="email" id="agentEmail">
                </div>
                <div class="form-group">
                    <label for="agentUsername">Login Username *</label>
                    <input type="text" id="agentUsername" required>
                    <small style="color: var(--text-secondary); font-size: 0.85rem;">Username for agent to log in to the system</small>
                </div>
                <div class="form-group">
                    <label for="agentPassword">Login Password <span id="agentPasswordRequired">*</span></label>
                    <input type="password" id="agentPassword">
                    <small id="agentPasswordHint" style="color: var(--text-secondary); font-size: 0.85rem;">Leave blank when editing to keep existing password</small>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">Save</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('agentModal')">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Payment QR Modal -->
    <div id="paymentModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Payment</h2>
            <div id="paymentDetails"></div>
            <div id="qrCodeContainer"></div>
            <div class="form-actions">
                <button class="btn btn-success" id="markPaidBtn">Mark as Paid</button>
                <button type="button" class="btn btn-secondary" onclick="closeModal('paymentModal')">Close</button>
            </div>
        </div>
    </div>

    <!-- Assign Customers to Agent Modal -->
    <div id="assignCustomersModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <span class="close">&times;</span>
            <h2 id="assignCustomersModalTitle">Assign Customers to Agent</h2>
            <div id="assignCustomersContent">
                <div style="margin-bottom: 20px;">
                    <input type="text" id="customerSearchAssign" placeholder="Search by Office, Name, or Phone Number..." style="width: 100%; padding: 8px; margin-bottom: 10px;">
                    <p style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 5px; margin-bottom: 10px;">
                        You can search by: <strong>Office</strong>, <strong>Customer Name</strong>, or <strong>Phone Number</strong>
                    </p>
                    <div style="display: flex; gap: 10px; margin-bottom: 15px; align-items: center;">
                        <button class="btn btn-sm btn-primary" onclick="agentManager.selectAllCustomers()">Select All</button>
                        <button class="btn btn-sm btn-secondary" onclick="agentManager.deselectAllCustomers()">Deselect All</button>
                        <span id="selectedCount" style="padding: 8px; color: var(--text-secondary); font-weight: 500;"></span>
                    </div>
                </div>
                <div id="customersAssignList" style="max-height: 400px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 4px; padding: 10px;">
                    <!-- Customer list will be populated here -->
                </div>
                <div class="form-actions" style="margin-top: 20px;">
                    <button type="button" class="btn btn-success" id="saveAssignmentsBtn">Save Assignments</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('assignCustomersModal')">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Excel Import Modal -->
    <div id="excelImportModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <span class="close">&times;</span>
            <h2>Import Customers from Excel</h2>
            <div id="excelImportContent">
                <div class="form-group">
                    <label>Excel File Format</label>
                    <p style="font-size: 0.9rem; color: var(--text-secondary); margin-top: 5px;">
                        Your Excel file should have these columns: <strong>Office, Serial No, Customer Name, Phone, Area, Package, ID, Box Number</strong>
                    </p>
                    <p style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 5px;">
                        Note: The first row can be headers. Column order can vary, but column names should match exactly.
                    </p>
                </div>
                <div class="form-group">
                    <label for="excelFileInput">Select Excel File (.xlsx, .xls) *</label>
                    <input type="file" id="excelFileInput" accept=".xlsx,.xls" style="padding: 8px;">
                </div>
                <div id="excelPreview" style="margin-top: 20px; display: none;">
                    <h3>Preview (First 10 rows)</h3>
                    <div id="excelPreviewTable" style="overflow-x: auto; max-height: 400px;"></div>
                    <div id="excelImportSummary" style="margin-top: 15px;"></div>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-success" id="processExcelBtn" style="display: none;">Import Customers</button>
                    <button type="button" class="btn btn-secondary" onclick="closeModal('excelImportModal')">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <!-- Configuration - Update API URL here for production -->
    <script src="config.js"></script>
    <script src="https://cdn.rawgit.com/davidshimjs/qrcodejs/gh-pages/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <!-- API must be loaded first -->
    <script src="js/api.js"></script>
    <script>
        // Ensure api is available globally
        if (window.api) {
            // API is already available via window.api, no need to redeclare
            console.log('API service loaded successfully');
        } else {
            console.error('API service failed to load!');
        }
    </script>
    <script src="js/app.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/packages.js"></script>
    <script src="js/agents.js"></script>
    <script src="js/customers.js"></script>
    <script src="js/payments.js"></script>
    <script src="js/agent-reports.js"></script>
    <script src="js/reports.js"></script>
    <script src="js/reminders.js"></script>
</body>
</html>

